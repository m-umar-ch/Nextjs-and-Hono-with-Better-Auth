# Hono Starter Project Rules

This document contains the coding standards, patterns, and conventions for the Hono Starter project.

## Overview

This project follows NestJS-inspired naming conventions and patterns while using Hono as the web framework. The codebase emphasizes:

- **Structured Architecture**: Clear module separation with consistent naming
- **Standardized Responses**: Unified API response patterns
- **Comprehensive Logging**: Structured logging with Sentry integration
- **Type Safety**: Full TypeScript coverage with proper typing

## Rule Categories

### 1. [Naming Conventions](./rules/naming-conventions.mdc)

- Module structure and file naming patterns
- Import/export conventions
- Variable and function naming standards
- Consistency rules across the codebase

**Key Points:**

- Controllers: `{module}.controller.ts`
- Services: `{module}.service.ts`
- Entities: `{module}.entity.ts`
- Routes: `{action}.{module}.route.ts`

### 2. [Response Patterns](./rules/response-patterns.mdc)

- Standardized API response utilities
- Success and error response structures
- Pagination patterns
- HTTP status code usage

**Key Points:**

- Use `HONO_RESPONSE()` for success responses
- Use `HONO_ERROR()` for error responses
- Use `HONO_PAGINATED_RESPONSE()` for lists
- Always include proper status codes and messages

### 3. [Error Handling](./rules/error-handling.mdc)

- Prefer `tryCatch` function from `@/lib/utils/async-utils.ts`
- Result pattern for better error handling
- Avoid try-catch blocks where possible

**Key Points:**

- Always use `tryCatch` for async operations
- Destructure `{ data, error }` from results
- Check for errors before using data
- Combine with `HONO_LOGGER` for logging

### 4. [Logging Patterns](./rules/logging-patterns.mdc)

- Structured logging with context data
- Sentry integration for error tracking
- Log level usage guidelines
- Performance and debugging patterns

**Key Points:**

- Use `HONO_LOGGER` for all logging
- Always include structured context
- Integrate with Sentry for production monitoring
- Follow appropriate log levels

### 5. [Authentication & Authorization Patterns](./rules/auth-patterns.mdc)

- Middleware-based permission checking
- Type-safe permission definitions
- Better Auth integration
- Route handler authorization patterns

**Key Points:**

- Always use `requirePermissions` middleware instead of manual checks
- Use `requireAuth` only when authentication is sufficient
- Never check permissions manually in route handlers
- Leverage IntelliSense for type-safe permissions

## Project Structure

```
src/
├── modules/
│   ├── auth/
│   │   ├── entity/
│   │   │   └── auth.entity.ts
│   │   └── service/
│   │       ├── auth-client.ts
│   │       ├── auth.service.ts
│   │       ├── auth.ts (Better Auth instance)
│   │       └── permissions.ts
│   ├── user/
│   │   ├── controller/
│   │   │   └── user.controller.ts
│   │   ├── entity/
│   │   │   └── user.entity.ts
│   │   ├── service/
│   │   │   └── user.service.ts
│   │   └── routes/ (for future route handlers)
│   ├── mailer/
│   │   ├── controller/
│   │   │   └── mailer.controller.ts
│   │   ├── service/
│   │   │   └── mailer.service.ts
│   │   ├── routes/
│   │   │   └── post.mailer.route.ts
│   │   ├── templates/
│   │   │   ├── email-verification-otp.ts
│   │   │   ├── email-verification.ts
│   │   │   ├── order-confirmation.ts
│   │   │   ├── password-reset-otp.ts
│   │   │   ├── password-reset.ts
│   │   │   ├── signin-otp.ts
│   │   │   ├── welcome.ts
│   │   │   └── index.ts
│   │   ├── index.ts
│   │   └── README.md
│   └── module.tags.ts
├── db/
│   ├── schema/
│   │   └── index.ts (exports all entities)
│   ├── migrations/
│   │   ├── 0000_certain_spitfire.sql
│   │   ├── 0001_smart_wolfsbane.sql
│   │   └── meta/
│   └── extras/
│       ├── DB_Backup.md
│       └── db.utils.ts
├── lib/
│   ├── core/
│   │   ├── create-router.ts
│   │   ├── hono-logger.ts
│   │   ├── open-api.config.ts
│   │   ├── sentry.ts
│   │   └── SENTRY_SETUP.md
│   ├── http/
│   │   └── status-codes.ts
│   ├── middlewares/
│   │   ├── auth.middleware.ts
│   │   ├── cors.middleware.ts
│   │   ├── favicon-middleware.ts
│   │   ├── not-found-middleware.ts
│   │   ├── on-error.middleware.ts
│   │   └── sentry.middleware.ts
│   ├── schemas/
│   │   └── api-schemas.ts
│   └── utils/
│       ├── async-utils.ts
│       ├── index.ts
│       ├── response-utils.ts
│       ├── string-utils.ts
│       └── README.md
├── env.ts
└── main.ts
```

## Quick Reference

### Creating a New Module

1. Create module directory: `src/modules/{module-name}/`
2. Add controller: `controller/{module-name}.controller.ts`
3. Add service: `service/{module-name}.service.ts`
4. Add entity: `entity/{module-name}.entity.ts` (also export from `src/db/schema/index.ts`)
5. Add routes: `routes/{action}.{module-name}.route.ts`
6. (Optional) Add `index.ts` for module exports
7. Register controller in `src/main.ts` controllers array

### Route Handler Template

```typescript
import { createRoute, z } from "@hono/zod-openapi";
import type { AuthenticatedRouteHandler } from "@/lib/core/create-router";
import { HTTP } from "@/lib/http/status-codes";
import { requirePermissions } from "@/lib/middlewares/auth.middleware";
import { APISchema } from "@/lib/schemas/api-schemas";
import { HONO_RESPONSE, HONO_ERROR } from "@/lib/utils";
import { tryCatch } from "@/lib/utils";
import { HONO_LOGGER } from "@/lib/core/hono-logger";

export const POST_Route = createRoute({
  path: "/resource",
  method: "post",
  request: {
    body: {
      content: {
        "application/json": {
          schema: z.object({
            // Your schema here
          }),
        },
      },
    },
  },
  middleware: [requirePermissions({ resource: ["create"] })],
  responses: {
    [HTTP.CREATED]: APISchema.response({
      data: YourSchema,
      statusCode: "CREATED",
    }),
    [HTTP.FORBIDDEN]: APISchema.FORBIDDEN,
    [HTTP.INTERNAL_SERVER_ERROR]: APISchema.INTERNAL_SERVER_ERROR,
  },
});

export const POST_Handler: AuthenticatedRouteHandler<
  typeof POST_Route
> = async (c) => {
  const requestId = c.get("requestId");
  const body = c.req.valid("json");

  HONO_LOGGER.log("Operation started", { requestId });

  const { data: result, error } = await tryCatch(
    SomeService.performOperation(body)
  );

  if (error) {
    HONO_LOGGER.error("Operation failed", { requestId, error });
    return HONO_ERROR(
      c,
      "INTERNAL_SERVER_ERROR",
      "Operation failed. Please try again."
    );
  }

  HONO_LOGGER.log("Operation completed", { requestId });
  return HONO_RESPONSE(c, {
    data: result,
    statusCode: "CREATED",
    message: "Resource created successfully",
  });
};
```

### Service Class Template

```typescript
import { tryCatch } from "@/lib/utils";
import { HONO_LOGGER } from "@/lib/core/hono-logger";

export class ModuleService {
  static async performOperation(data: any) {
    HONO_LOGGER.debug("Starting operation", { data });

    const { data: result, error } = await tryCatch(someAsyncOperation(data));

    if (error) {
      HONO_LOGGER.error("Operation failed", {
        data,
        error: error.message,
      });

      HONO_LOGGER.sentry.captureException(error, {
        operation: "module_operation",
        data,
      });

      throw error;
    }

    HONO_LOGGER.log("Operation successful", { result });
    return result;
  }
}
```

## Development Guidelines

### Code Quality

- Follow TypeScript strict mode
- Use `tryCatch` for error handling (avoid try-catch blocks)
- Include comprehensive logging with context
- Write descriptive commit messages
- Use meaningful variable and function names

### API Design

- RESTful endpoint design
- Consistent response structures
- Proper HTTP status codes
- Comprehensive error messages
- Input validation with Zod schemas

### Performance

- Log performance metrics
- Use appropriate database queries
- Implement proper caching strategies
- Monitor memory usage
- Track request/response times

### Security

- Never log sensitive information
- Validate all inputs
- **Always use `requirePermissions` middleware** for route authorization (see [Auth Patterns](./rules/auth-patterns.mdc))
- Use `requireAuth` only when authentication is sufficient (rare)
- Never check permissions manually in route handlers
- Implement rate limiting
- Follow OWASP guidelines

## Tools and Dependencies

- **Framework**: Hono (v4.9.2)
- **Runtime**: Bun
- **Database**: Drizzle ORM (v0.44.4) with PostgreSQL (postgres v3.4.7)
- **Validation**: Zod (v4.0.17) with @hono/zod-openapi (v1.1.0)
- **Authentication**: Better Auth (v1.3.11)
- **Logging**: Custom structured logger with Sentry (v10.11.0)
- **Email**: Resend (v6.0.3)
- **API Documentation**: @scalar/hono-api-reference (v0.9.13)
- **Code Formatting**: @biomejs/biome (v2.2.0)

## Getting Started

1. Follow the naming conventions for new files
2. Use the response utilities for all API responses
3. Use `tryCatch` for all async error handling
4. Implement structured logging throughout your code
5. Include proper error handling and validation
6. Write comprehensive tests for your modules

For detailed information on each topic, refer to the specific rule files in the `rules/` directory.
