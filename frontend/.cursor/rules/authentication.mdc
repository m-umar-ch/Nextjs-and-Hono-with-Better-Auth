# Authentication Patterns

## Overview

Always use the provided authentication utilities from `@/DAL/auth` in server components. These utilities use `tryCatch` internally for proper error handling. Never use the `useSession` hook from Better Auth.

## Import Statements

```typescript
// ✅ CORRECT: Use provided utilities
import { getUser, getSession } from "@/DAL/auth";

// ❌ INCORRECT: Don't import authClient directly in server components
import { authClient } from "@/auth/auth-client"; // DON'T DO THIS
```

## Server Components

### Get User (Most Common)

Use `getUser()` when you only need the user object:

```typescript
// ✅ CORRECT: Using getUser utility
import { getUser } from "@/DAL/auth";
import { redirect } from "next/navigation";

export default async function ServerComponent() {
  const user = await getUser();

  if (!user) {
    redirect("/login");
  }

  return <div>Welcome {user.email}</div>;
}
```

### Get Full Session

Use `getSession()` when you need both user and session data:

```typescript
// ✅ CORRECT: Using getSession utility
import { getSession } from "@/DAL/auth";

export default async function ServerComponent() {
  const session = await getSession();

  if (!session?.user) {
    return <div>Not authenticated</div>;
  }

  const user = session.user;
  const sessionData = session.session;

  return <div>Welcome {user.email}</div>;
}
```

### Protected Routes

For protected routes, use `getUser()` and redirect if not authenticated:

```typescript
// ✅ CORRECT: Protected route pattern
import { getUser } from "@/DAL/auth";
import { redirect } from "next/navigation";

export default async function ProtectedPage() {
  const user = await getUser();

  if (!user) {
    redirect("/login");
  }

  return <div>Protected content for {user.email}</div>;
}
```

## Client Components

In client components, you can access session on the client side:

```typescript
"use client";

import { authClient } from "@/auth/auth-client";
import { useEffect, useState } from "react";

export function ClientComponent() {
  const [user, setUser] = useState(null);

  useEffect(() => {
    authClient.getSession().then(({ data }) => {
      setUser(data?.user);
    });
  }, []);

  return <div>{user?.email}</div>;
}
```

However, prefer server components for authentication checks when possible.

## ❌ NEVER Use useSession Hook

```typescript
// ❌ INCORRECT: Don't use useSession hook
import { useSession } from "better-auth/react"; // DON'T DO THIS

export function Component() {
  const { data } = useSession(); // DON'T DO THIS
  // ...
}
```

## Best Practices

### DO

- ✅ Always use `getUser()` or `getSession()` from `@/DAL/auth` in server components
- ✅ Check if user/session exists before accessing properties
- ✅ Redirect to login page if authentication fails
- ✅ Use server components for authentication checks when possible
- ✅ Use `getUser()` when you only need the user object
- ✅ Use `getSession()` when you need both user and session data

### DON'T

- ❌ Never use `useSession` hook from Better Auth
- ❌ Don't use `authClient.getSession()` directly in server components (use utilities instead)
- ❌ Don't manually wrap `authClient.getSession()` with `tryCatch` (utilities handle this)
- ❌ Don't access user properties without checking if user exists
- ❌ Don't perform authentication checks in client components unnecessarily

## Examples

### Page with User Info

```typescript
// ✅ CORRECT: Using getUser utility
import { getUser } from "@/DAL/auth";
import SignOutButton from "@/components/common/sign-out-button";

export default async function HomePage() {
  const user = await getUser();

  return (
    <main>
      <h1>Welcome {user?.email || "Guest"}</h1>
      {user && <SignOutButton />}
    </main>
  );
}
```

### Protected Layout

```typescript
// ✅ CORRECT: Protected layout pattern
import { getUser } from "@/DAL/auth";
import { redirect } from "next/navigation";

export default async function ProtectedLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const user = await getUser();

  if (!user) {
    redirect("/login");
  }

  return <div>{children}</div>;
}
```

### Conditional Rendering Based on Auth

```typescript
// ✅ CORRECT: Conditional rendering
import { getUser } from "@/DAL/auth";
import Link from "next/link";
import SignOutButton from "@/components/common/sign-out-button";

export default async function Navigation() {
  const user = await getUser();

  return (
    <nav>
      {user ? (
        <>
          <span>Logged in as {user.email}</span>
          <SignOutButton />
        </>
      ) : (
        <Link href="/login">Login</Link>
      )}
    </nav>
  );
}
```

### Getting Full Session Data

```typescript
// ✅ CORRECT: When you need both user and session
import { getSession } from "@/DAL/auth";

export default async function Page() {
  const session = await getSession();

  if (!session?.user) {
    return <div>Not authenticated</div>;
  }

  // Access both user and session data
  const user = session.user;
  const sessionData = session.session;
  const expiresAt = sessionData?.expiresAt;

  return (
    <div>
      <p>User: {user.email}</p>
      <p>Session expires: {expiresAt?.toLocaleString()}</p>
    </div>
  );
}
```

## Type Safety

The utility functions return types:

```typescript
// getUser() returns User | null
const user = await getUser();
// user is User | null

// getSession() returns { user: User | null, session: Session | null } | null
const session = await getSession();
// session?.user is User | null
// session?.session is Session | null
```

## Error Handling

The utilities handle errors internally and return `null` on failure:

```typescript
import { getUser } from "@/DAL/auth";

export default async function Component() {
  const user = await getUser();

  // Handle unauthenticated state (includes error cases)
  if (!user) {
    return <div>Please log in to continue.</div>;
  }

  // User is authenticated
  return <div>Welcome {user.email}</div>;
}
```

The utilities automatically:

- ✅ Use `tryCatch` internally
- ✅ Handle headers for server-side requests
- ✅ Return `null` on error or unauthenticated state
- ✅ Log errors to console for debugging
